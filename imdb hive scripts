#######################################################################################################################
#Download files (can manually download or run the line below in the terminal)
##download IMDB dataset (will download and replace existing file, to be run daily)
wget -q https://datasets.imdbws.com/name.basics.tsv.gz -O /home/student/imdb/data/name.basics.tsv.gz
wget -q https://datasets.imdbws.com/title.akas.tsv.gz -O /home/student/imdb/data/title.akas.tsv.gz
wget -q https://datasets.imdbws.com/title.basics.tsv.gz -O /home/student/imdb/data/title.basics.tsv.gz
wget -q https://datasets.imdbws.com/title.crew.tsv.gz -O /home/student/imdb/data/title.crew.tsv.gz
wget -q https://datasets.imdbws.com/title.episode.tsv.gz -O /home/student/imdb/data/title.episode.tsv.gz
wget -q https://datasets.imdbws.com/title.principals.tsv.gz -O /home/student/imdb/data/title.principals.tsv.gz
wget -q https://datasets.imdbws.com/title.ratings.tsv.gz -O /home/student/imdb/data/title.ratings.tsv.gz


#######################################################################################################################
#Initialize the database and create table
#after starting the terminal
hive
create database imdb;
use imdb;

##create table for each files (only need to be created once)
#each table will need 2 table, 1 to store the tsv another one for parquet format
#name_basics
create table name_basics(nconst string, primaryName string, birthYear int, deathYear int, primaryProfession array<string>, knownforTitles array<string>) comment 'name basics' row format delimited fields terminated by '\t' collection items terminated by ',' tblproperties("skip.header.line.count"="1","serialization.null.format"="");

create table name_basics_pq(nconst string, primaryName string, birthYear int, deathYear int, primaryProfession array<string>, knownforTitles array<string>) stored as Parquet;

#title_akas
create table title_akas(titleId string, ordering int, title string, region string, language string, types array<string>, attributes array<string>, isOriginalTitle boolean) comment 'title AKAs' row format delimited fields terminated by '\t' collection items terminated by ',' tblproperties("skip.header.line.count"="1","serialization.null.format"="");

create table title_akas_pq(titleId string, ordering int, title string, region string, language string, types array<string>, attributes array<string>, isOriginalTitle boolean) stored as Parquet;

#title_basics
create table title_basics(tconst string, titleType string, primaryTitle string, originalTitle string, isAdult boolean, startYear int, endYear int, runtimeMinutes int, genres string) comment 'title basics' row format delimited fields terminated by '\t' tblproperties("skip.header.line.count"="1","serialization.null.format"="");

create table title_basics_pq(tconst string, titleType string, primaryTitle string, originalTitle string, isAdult boolean, startYear int, endYear int, runtimeMinutes int, genres string) stored as Parquet;

#title_crew
create table title_crew(tconst string, directors array<string>, writers array<string>) comment 'title crew' row format delimited fields terminated by '\t' collection items terminated by ',' tblproperties("skip.header.line.count"="1","serialization.null.format"="");

create table title_crew_pq(tconst string, directors array<string>, writers array<string>) stored as Parquet;

#title_episode
create table title_episode(tconst string, parentTconst string, seasonNumber int, episodeNumber int) comment 'title episode' row format delimited fields terminated by '\t' tblproperties("skip.header.line.count"="1","serialization.null.format"="");

create table title_episode_pq(tconst string, parentTconst string, seasonNumber int, episodeNumber int) comment 'title episode'stored as Parquet;

#title_principals
create table title_principal(tconst string, ordering int, nconst string, category string, job string) comment 'title principal' row format delimited fields terminated by '\t' tblproperties("skip.header.line.count"="1","serialization.null.format"="");

create table title_principal_pq(tconst string, ordering int, nconst string, category string, job string) stored as Parquet;

#title_ratings
create table title_ratings(tconst string, averageRating double, numVotes int) comment 'title ratings' row format delimited fields terminated by '\t' tblproperties("skip.header.line.count"="1","serialization.null.format"="");

create table title_ratings_pq(tconst string, averageRating double, numVotes int) comment 'title ratings' stored as Parquet;

#convert text format into parquet (if required), this code is not working
#error when reading the table after converting
#alter table table_name set fileformat Parquet;

##############################################################################
##load data from local to hive (every day)
load data local inpath '/home/student/imdb/data/name.basics.tsv.gz' into table name_basics;
load data local inpath '/home/student/imdb/data/title.akas.tsv.gz' into table title_akas;
load data local inpath '/home/student/imdb/data/title.basics.tsv.gz' into table title_basics;
load data local inpath '/home/student/imdb/data/title.crew.tsv.gz' into table title_crew;
load data local inpath '/home/student/imdb/data/title.episode.tsv.gz' into table title_episode;
load data local inpath '/home/student/imdb/data/title.principals.tsv.gz' into table title_principal;
load data local inpath '/home/student/imdb/data/title.ratings.tsv.gz' into table title_ratings;

##load data from hive tsv table to parquet
insert overwrite table name_basics_pq select * from name_basics;
insert overwrite table title_akas_pq select * from title_akas;
insert overwrite table title_basics_pq select * from title_basics;
insert overwrite table title_crew_pq select * from title_crew;
insert overwrite table title_episode_pq select * from title_episode;
insert overwrite table title_ratings_pq select * from title_ratings;


